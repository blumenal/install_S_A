# Variáveis - usar diretórios dinâmicos
SLSSTEAM_INSTALL_DIR=$(get_sls_install_dir)
SLSSTEAM_CONFIG_DIR=$(get_sls_config_dir)
STEAM_DIR=$(get_steam_dir)
STEAM_LIB_DIR="$STEAM_DIR/ubuntu12_32"
TEMP_SLS="/tmp/slssteam.7z"

# Obter família da distribuição para instalação de dependências
FAMILY=$(detect_distro_family)
if [ -z "$FAMILY" ]; then
    FAMILY="debian"
fi

# Instalar dependências do SLSsteam uma por uma, ignorando as indisponíveis
echo "Instalando dependências do SLSsteam..."
case "$FAMILY" in
    bazzite)
        # Bazzite usa rpm-ostree - dependências já devem estar na imagem base
        echo "  Bazzite detectado - ignorando instalação de dependências (pacotes estão na imagem base)"
        ;;
    fedora)
        SLS_PACKAGES="git libnotify curl libcurl-devel openssl-devel libcrypto-devel 7zip p7zip-plugins"
        install_packages_one_by_one "$SLS_PACKAGES" "$FAMILY"
        ;;
    debian)
        SLS_PACKAGES="git libnotify-bin curl 7zip-full libcurl4-openssl-dev libcurl4 libcurl4:i386 libcurl libcurl:i386 libssl3 libssl-dev libcrypto++6 libcrypto++-dev libxcb-cursor0"
        install_packages_one_by_one "$SLS_PACKAGES" "$FAMILY"
        ;;
    arch)
        SLS_PACKAGES="git libnotify curl 7zip"
        install_packages_one_by_one "$SLS_PACKAGES" "$FAMILY"
        ;;
esac

# Habilitar arquitetura i386 para Debian/Ubuntu se necessário
if [ "$FAMILY" = "debian" ]; then
    if ! dpkg --print-foreign-architectures 2>/dev/null | grep -q i386; then
        echo "Habilitando arquitetura i386..."
        sudo dpkg --add-architecture i386
        sudo apt update || true
    fi
fi

# Remover link simbólico antigo do libcurl se existir
if [ -d "$STEAM_LIB_DIR" ]; then
    rm -f "$STEAM_LIB_DIR/libcurl.so"*
    echo "Links simbólicos antigos do libcurl removidos."
fi

# Verificar se 7z está instalado, tentar unzip como fallback
EXTRACT_CMD=""
EXTRACT_TYPE=""
if command -v 7z >/dev/null 2>&1 || command -v 7za >/dev/null 2>&1; then
    EXTRACT_CMD="7z x"
    EXTRACT_TYPE="7z"
elif command -v unzip >/dev/null 2>&1; then
    echo -e "${YELLOW}Aviso: 7z não encontrado, usando unzip como fallback${NC}"
    EXTRACT_CMD="unzip -AA"
    EXTRACT_TYPE="unzip"
elif [ "$FAMILY" = "bazzite" ]; then
    # Bazzite: 7z deve estar na imagem base, avisar e falhar
    echo -e "${YELLOW}Aviso: 7z não disponível no Bazzite${NC}"
    echo "Instalação do SLSsteam será ignorada."
    return 1
else
    echo "Instalando p7zip..."
    if case "$FAMILY" in
        fedora) sudo dnf install -y p7zip p7zip-plugins ;;
        debian) sudo apt install -y p7zip-full ;;
        arch)   sudo pacman -Sy --noconfirm p7zip ;;
    esac; then
        EXTRACT_CMD="7z x"
        EXTRACT_TYPE="7z"
    else
        echo -e "${YELLOW}Aviso: Não foi possível instalar 7z, tentando unzip...${NC}"
        if command -v unzip >/dev/null 2>&1; then
            EXTRACT_CMD="unzip -AA"
            EXTRACT_TYPE="unzip"
        else
            echo -e "${YELLOW}Aviso: Nem 7z nem unzip disponíveis${NC}"
            echo "Instalação do SLSsteam será ignorada."
            return 1
        fi
    fi
fi

# Verificar se wget está instalado, tentar curl como fallback
DOWNLOAD_CMD=""
if command -v wget >/dev/null 2>&1; then
    DOWNLOAD_CMD="wget -q -O"
elif command -v curl >/dev/null 2>&1; then
    echo -e "${YELLOW}Aviso: wget não encontrado, usando curl como fallback${NC}"
    DOWNLOAD_CMD="curl -sL -o"
elif [ "$FAMILY" = "bazzite" ]; then
    # Bazzite: wget/curl devem estar na imagem base, avisar e falhar
    echo -e "${YELLOW}Aviso: Nem wget nem curl disponíveis no Bazzite${NC}"
    echo "Instalação do SLSsteam será ignorada."
    return 1
else
    echo "Instalando wget..."
    if case "$FAMILY" in
        fedora) sudo dnf install -y wget ;;
        debian) sudo apt install -y wget ;;
        arch)   sudo pacman -Sy --noconfirm wget ;;
    esac; then
        DOWNLOAD_CMD="wget -q -O"
    else
        echo -e "${YELLOW}Aviso: Não foi possível instalar wget, tentando curl...${NC}"
        if command -v curl >/dev/null 2>&1; then
            DOWNLOAD_CMD="curl -sL -o"
        else
            echo -e "${YELLOW}Aviso: Nem wget nem curl disponíveis${NC}"
            echo "Instalação do SLSsteam será ignorada."
            return 1
        fi
    fi
fi

# Verificar se o Steam está instalado (apenas aviso, não falhar)
if ! STEAM_DIR=$(find_steam_directory); then
    echo -e "${YELLOW}Aviso: Diretório do Steam não encontrado${NC}"
    echo "Instalação do SLSsteam será ignorada."
    echo "Instale o Steam e execute novamente este script para habilitar o SLSsteam."
    return 0
fi

# Verificar se o Steam está em execução e avisar o usuário
STEAM_PID=$(pgrep -x "steam" 2>/dev/null || true)
if [ -n "$STEAM_PID" ]; then
    echo -e "${YELLOW}Steam está em execução. Por favor feche o Steam manualmente.${NC}"
    if [ -t 0 ]; then
        echo "Pressione Enter após fechar o Steam..."
        read -r
        STEAM_PID=$(pgrep -x "steam" 2>/dev/null || true)
        while [ -n "$STEAM_PID" ]; do
            echo "Steam ainda está em execução. Por favor feche-o."
            sleep 2
            STEAM_PID=$(pgrep -x "steam" 2>/dev/null || true)
        done
    else
        echo "Reinicie o Steam após a instalação ser concluída."
        sleep 3
    fi
fi

# Criar diretórios
mkdir -p "$SLSSTEAM_INSTALL_DIR"
mkdir -p "$SLSSTEAM_CONFIG_DIR"

# Backup da configuração existente
if [ -f "$SLSSTEAM_CONFIG_DIR/config.yaml" ]; then
    cp "$SLSSTEAM_CONFIG_DIR/config.yaml" "$SLSSTEAM_CONFIG_DIR/config.yaml.bak"
    echo "Backup da configuração criado."
fi

echo "Baixando SLSsteam..."
# Obter dados da release da API do GitHub
RELEASE_JSON=$(curl -s "https://api.github.com/repos/AceSLS/SLSsteam/releases/latest")

if [ -z "$RELEASE_JSON" ] || echo "$RELEASE_JSON" | grep -q '"message":'; then
    echo -e "${RED}Erro ao buscar informações da release do SLSsteam.${NC}"
    return 1
fi

# Extrair URL de download usando grep com padrão mais específico
LATEST_URL=$(echo "$RELEASE_JSON" | grep -o '"browser_download_url": *"[^\"]*SLSsteam-Any\.7z"' | \
             sed 's/"browser_download_url": *"\([^\"]*\)"/\1/' | head -1)

if [ -z "$LATEST_URL" ]; then
    echo -e "${RED}Erro: Não foi possível encontrar SLSsteam-Any.7z nos assets da release.${NC}"
    return 1
fi

if ! $DOWNLOAD_CMD "$TEMP_SLS" "$LATEST_URL"; then
    echo -e "${RED}Erro ao baixar SLSsteam.${NC}"
    rm -f "$TEMP_SLS"
    return 1
fi

# Extrair e instalar
echo "Extraindo SLSsteam..."
rm -rf /tmp/slssteam_extract
mkdir -p /tmp/slssteam_extract

if ! $EXTRACT_CMD "$TEMP_SLS" -o/tmp/slssteam_extract -y 2>&1 | tail -5; then
    echo -e "${RED}Erro ao extrair arquivo.${NC}"
    rm -rf /tmp/slssteam_extract "$TEMP_SLS"
    return 1
fi

# Encontrar SLSsteam.so em qualquer subdiretório
SLSSTEAM_SO=$(find /tmp/slssteam_extract -name "SLSsteam.so" -type f 2>/dev/null | head -1)

if [ -z "$SLSSTEAM_SO" ]; then
    echo -e "${RED}Erro: SLSsteam.so não encontrado no arquivo.${NC}"
    echo "Conteúdo do arquivo:"
    find /tmp/slssteam_extract -type f 2>/dev/null | head -20
    rm -rf /tmp/slssteam_extract "$TEMP_SLS"
    return 1
fi

echo "SLSsteam.so encontrado em: $SLSSTEAM_SO"

# Configurar SLSsteam: garantir que PlayNotOwnedGames está habilitado (antes da limpeza)
mkdir -p "$SLSSTEAM_CONFIG_DIR"
if [ ! -f "$SLSSTEAM_CONFIG_DIR/config.yaml" ]; then
    if [ -f "/tmp/slssteam_extract/res/config.yaml" ]; then
        cp /tmp/slssteam_extract/res/config.yaml "$SLSSTEAM_CONFIG_DIR/config.yaml"
    fi
fi

if grep -q "^PlayNotOwnedGames:" "$SLSSTEAM_CONFIG_DIR/config.yaml" 2>/dev/null; then
    sed -i 's/^PlayNotOwnedGames:.*/PlayNotOwnedGames: yes/' "$SLSSTEAM_CONFIG_DIR/config.yaml"
    echo "PlayNotOwnedGames habilitado na configuração."
else
    echo "PlayNotOwnedGames: yes" >> "$SLSSTEAM_CONFIG_DIR/config.yaml"
    echo "PlayNotOwnedGames adicionado à configuração."
fi

# Executar setup.sh do SLSsteam install (lida com wrappers, arquivos desktop, etc.)
cd /tmp/slssteam_extract
if [ -f "setup.sh" ]; then
    ./setup.sh install
else
    echo "setup.sh não encontrado, usando instalação manual como fallback..."
    # Fallback: instalação manual
    cp "$SLSSTEAM_SO" "$SLSSTEAM_INSTALL_DIR/"
fi

rm -rf /tmp/slssteam_extract "$TEMP_SLS"

echo ""
echo -e "${GREEN}Finalizando configuração do Steam...${NC}"
finalize_steam

echo ""
echo -e "${GREEN}Aplicando patch nos scripts do Steam...${NC}"
configure_slssteam_injection

# Steam Deck: aplicar patch no steam-jupiter para o Modo de Jogo
if [ -f "/usr/bin/steam-jupiter" ]; then
    echo ""
    echo -e "${GREEN}Aplicando patch no steam-jupiter para o Modo de Jogo do Steam Deck...${NC}"
    patch_steam_jupiter
fi

# Sempre aplicar patch no steam.sh (usado no Modo Desktop, mesmo no Steam Deck)
if [ -f "$HOME/.steam/steam/steam.sh" ] || [ -f "$HOME/.local/share/Steam/steam.sh" ]; then
    patch_steam_sh
fi

# Criar wrapper em /usr/local/bin/steam para o Modo de Jogo do Bazzite (injeção redundante)
echo ""
echo -e "${GREEN}Criando wrapper do Steam para injeção no Modo de Jogo...${NC}"
create_steam_wrapper

echo ""
echo "SLSsteam instalado e configurado com sucesso!"
echo "Abra o Steam normalmente para jogar."
